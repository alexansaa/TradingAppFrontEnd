trigger:
- main
pr:
- '*'

pool:
  name: Default

variables:
  app_location: '/'
  output_location: 'dist'

steps:
- checkout: self

- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: Use Node 20

- task: Cache@2
  displayName: Cache npm
  inputs:
    key: 'npm | "$(Agent.OS)" | package-lock.json'
    path: $(Pipeline.Workspace)/.npm

- script: |
    set -e
    npm config set cache "$(Pipeline.Workspace)/.npm" --global
    npm ci
    npm run build
  displayName: Build SPA
  env:
    VITE_API_BASE_URL: $(VITE_API_BASE_URL)

# ---- Production deploy (main branch) ----
- task: AzureStaticWebApp@0
  displayName: Deploy to SWA (production)
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  inputs:
    azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN)
    app_location: $(app_location)
    output_location: $(output_location)
    deployment_environment: 'production'
